# MinerU 解析文件上传与资源路径替换

## 📖 简介

**MinerU 解析文件上传与资源路径替换** 是 PDF 解析 RAG 工作流的核心 ETL (Extract, Transform, Load) 工具。它承接上游的解析结果，负责下载 MinerU 生成的 ZIP 包，将其中的图片流式提取并上传至 MaxKB 对象存储，最后将 Markdown 中的本地路径替换为可访问的远程 URL。

本工具采用了**生产者-消费者模型**和**背压机制**，专为在资源受限环境（如 256MB 内存）下处理大文件（>50MB）而设计，彻底解决了内存溢出 (OOM) 问题。

---

## ✨ 核心功能

* **流式解压与上传**：放弃传统的全量解压，采用流式读取 ZIP 内的图片文件，即读即传即释放，极低内存占用。
* **背压控制 (Backpressure)**：通过 `queue_size` 限制内存中积压的待上传图片数量，防止生产速度过快撑爆内存。
* **智能存储策略**：自动探测 `/dev/shm` (内存盘) 和 `/tmp` (磁盘)，优先将大文件缓存至磁盘，仅在无写权限时降级为内存模式。
* **动态并发**：支持配置并发上传线程数，适应不同性能的服务器环境。
* **Markdown 清洗**：自动将文档中的相对路径（如 `images/01.png`）替换为 MaxKB 的永久链接。

---

## 🛠️ 使用说明 

### 1. 前置条件

* **磁盘写权限**：必须开启 MaxKB 容器的 `/tmp` 写权限（设置环境变量 `MAXKB_SANDBOX_TMP_DIR_ENABLED=1`）。
* **网络连通性**：MaxKB 服务器必须能够访问 MinerU 的下载链接。

### 2. 参数配置

在工作流节点中，请按照以下说明配置输入参数：

| 参数名 (`Key`) | 类型 | 必填 | 说明                                                             | 示例值 |
| :--- | :--- | :--- |:---------------------------------------------------------------| :--- |
| `miner_data` | Dict | ✅ | 引用上游 **MinerU 任务提取** 工具的输出结果。包含 ZIP 下载地址等信息。                   | `{{task_submitter.result}}` |
| `kb_id` | String | ✅ | 目标知识库 ID。上传的图片将归属于此知识库。                                        | `019c2...` |
| `maxkb_api_token` | String | ✅ | MaxKB 的 API Token。用于鉴权图片上传接口。                                  | `eyJhbGciOiJIUzI1Ni...` |
| `maxkb_base_url` | String | ✅ | MaxKB 的公网访问域名。用于生成图片预览链接。                                      | `https://kb.yourdomain.com` |
| `concurrency` | Integer | ❌ | **并发上传线程数**。默认 4。内存受限环境建议 2-4；高性能环境建议 8-16。                    | `4` |
| `queue_size` | Integer | ❌ | **内存队列缓冲大小**。默认 8。控制内存积压图片数。**256MB 内存强烈建议填 8**；1GB+ 内存可填 30+。 | `10` |

### 3. 输出结果

工具执行成功后，将返回一个 JSON 对象，供下游“文档分段”节点使用：

* `content`: 经过清洗、图片路径已替换为远程 URL 的完整 Markdown 文本。
* `md_remote_url`: 清洗后的 Markdown 文件本身的下载链接。
* `image_count`: 成功处理并上传的图片总数。
* `errors`: 上传失败的文件列表（如有）。


---

## ⚠️ 注意事项

1.  **内存溢出 (OOM)**：如果遇到脚本静默退出（无报错），通常是 OOM 导致的。请尝试：
    * 减小 `concurrency` 至 2。
    * 减小 `queue_size` 至 5。
    * 增加容器内存限制 `MAXKB_SANDBOX_PYTHON_PROCESS_LIMIT_MEM_MB`。
2.  **超时问题**：处理包含数百张图片的大型 PDF 时，上传过程可能耗时较长。请确保环境变量 `MAXKB_SANDBOX_PYTHON_PROCESS_LIMIT_TIMEOUT_SECONDS` 设置足够大（建议 3600s 以上）。
3.  **临时文件清理**：脚本会自动清理下载的临时 ZIP 文件，但建议定期检查 `/tmp` 目录以防万一。